<!DOCTYPE html>
<html>
<head>
    <!-- Th√™m c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/uuid@8.3.2/dist/umd/uuid.min.js"></script>
    <style>
        /* Reset CSS */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
        }

        .container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        h2 {
            color: #1877f2;
            margin-bottom: 1.5rem;
            font-size: 2rem;
            text-align: center;
        }

        button {
            background: #1877f2;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background: #166fe5;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(0);
        }

        #accountInput {
            width: 100%;
            height: 120px;
            padding: 1rem;
            border: 2px solid #dddfe2;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        #accountInput:focus {
            border-color: #1877f2;
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dddfe2;
        }

        th {
            background: #f5f6f7;
            font-weight: 600;
            color: #606770;
        }

        tr:hover {
            background: #f5f6f7;
        }

        .status-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }

        .copy-otp {
            color: #1877f2;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .copy-otp:hover {
            opacity: 0.8;
        }

        #toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #1877f2;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
        }

        #toast.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            button {
                width: 100%;
                justify-content: center;
                margin: 0.5rem 0;
            }

            th, td {
                min-width: 120px;
                padding: 0.8rem;
            }

            h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .password-cell {
                flex-direction: column;
                align-items: flex-start;
            }

            .toggle-password {
                margin-top: 0.3rem;
            }
        }

        /* Th√™m style cho input domain */
        .input-group {
            display: flex;
            gap: 10px;
            margin: 1rem 0;
        }
        
        .domain-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #dddfe2;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .domain-input:focus {
            border-color: #1877f2;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>MailTM Bulk OTP Checker</h2>
        <div class="input-group">
            <input 
                type="text" 
                id="domainInput" 
                placeholder="Nh·∫≠p domain (m·∫∑c ƒë·ªãnh: edny.net)"
                class="domain-input"
            >
            <button onclick="createRandomAccount()">T·∫°o t√†i kho·∫£n m·ªõi</button>
        </div>
        <button onclick="importAccounts()">Import Accounts</button>
        <button onclick="clearTable()">X√≥a b·∫£ng</button>
        <textarea id="accountInput" placeholder="Nh·∫≠p danh s√°ch t√†i kho·∫£n (m·ªói d√≤ng 1 t√†i kho·∫£n theo ƒë·ªãnh d·∫°ng email|password)"></textarea>
        <table id="accountTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>OTP</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <!-- Th√™m div toast notification -->
    <div id="toast"></div>

<script>
class MailTM {
    constructor() {
        this.baseURL = "https://api.mail.tm";
        this.axiosInstance = axios.create();
        this.accountId = null;
        this.token = null;
        this.password = null;
    }

    async createAccount() {
        try {
            const domain = await this._getRandomDomain();
            const username = `${uuid.v4().substring(0,8)}@${domain}`;
            const password = uuid.v4().substring(0,10);
            
            console.log(`Username: ${username}, Password: ${password}`);
            
            const response = await this.axiosInstance.post(
                `${this.baseURL}/accounts`,
                { address: username, password: password }
            );

            if (response.status === 201) {
                this.accountId = username;
                this.password = password;
                const loginSuccess = await this.login(username, password);
                return loginSuccess 
                    ? { email: username, password: password }
                    : { error: "T·∫°o t√†i kho·∫£n th√†nh c√¥ng nh∆∞ng ƒëƒÉng nh·∫≠p th·∫•t b·∫°i" };
            }

            const errorMsg = response.data?.detail || 'Unknown error';
            if (response.status === 400) {
                return { error: `Sai ƒë·ªãnh d·∫°ng email: ${errorMsg}` };
            } else if (response.status === 422) {
                return { error: `Domain ${domain} kh√¥ng kh·∫£ d·ª•ng, vui l√≤ng th·ª≠ domain kh√°c` };
            }
            return { error: `L·ªói ${response.status}: ${errorMsg}` };

        } catch (error) {
            return { 
                error: `L·ªói k·∫øt n·ªëi: ${error.response?.data?.detail || error.message}`
            };
        }
    }

    async login(email, password) {
        this.accountId = email;
        this.password = password;
        
        try {
            const response = await this.axiosInstance.post(
                `${this.baseURL}/token`,
                { address: email, password: password }
            );
            
            if (response.status === 200) {
                this.token = response.data.token;
                this.axiosInstance.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
                return true;
            }
            return false;
        } catch (error) {
            return false;
        }
    }

    async getOTP(timeout = 60) {
        if (!this.token) throw new Error("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
        
        const startTime = Date.now();
        const regex = /\b\d{6}\b/;
        
        while (Date.now() - startTime < timeout * 1000) {
            try {
                const response = await this.axiosInstance.get(`${this.baseURL}/messages`);
                const messages = response.data['hydra:member'];
                
                if (messages.length > 0) {
                    const latestEmail = messages[0];
                    const emailRes = await this.axiosInstance.get(
                        `${this.baseURL}/messages/${latestEmail.id}`
                    );
                    
                    const content = emailRes.data.text || emailRes.data.html || '';
                    const otpMatch = content.match(regex);
                    if (otpMatch) return otpMatch[0];
                }
            } catch (error) {
                console.log(`L·ªói khi l·∫•y email: ${error.message}`);
            }
            await new Promise(resolve => setTimeout(resolve, 5000));
        }
        return null;
    }

    async _getRandomDomain() {
        const customDomain = document.getElementById('domainInput').value.trim();
        if (customDomain) return customDomain;
        
        // Domain m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng nh·∫≠p
        const defaultDomains = ["edny.net"];
        return defaultDomains[Math.floor(Math.random() * defaultDomains.length)];
    }
}

let mail = new MailTM();

// Hi·ªÉn th·ªã k·∫øt qu·∫£ ra m√†n h√¨nh
function showResult(text) {
    document.getElementById('result').textContent += text + '\n';
}

// X·ª≠ l√Ω import t√†i kho·∫£n
function importAccounts() {
    const input = document.getElementById('accountInput').value;
    const accounts = input.split('\n').filter(line => line.trim() !== '');
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    accounts.forEach((account, index) => {
        const [email, password] = account.split('|');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${email}</td>
            <td>${password}</td>
            <td><span class="status">üü° Ch∆∞a th·ª≠</span></td>
            <td class="otp-cell">-</td>
            <td>
                <button onclick="getOTPForAccount(this, '${email}', '${password}')">L·∫•y OTP</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// X·ª≠ l√Ω l·∫•y OTP cho t·ª´ng account
async function getOTPForAccount(button, email, password) {
    const row = button.closest('tr');
    const statusCell = row.querySelector('.status');
    const otpCell = row.querySelector('.otp-cell');
    const mail = new MailTM();

    try {
        statusCell.innerHTML = 'üîÑ ƒêang ƒëƒÉng nh·∫≠p...';
        const loginSuccess = await mail.login(email, password);
        
        if (!loginSuccess) {
            statusCell.innerHTML = 'üî¥ ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
            return;
        }

        statusCell.innerHTML = 'üîÑ ƒêang l·∫•y OTP...';
        button.disabled = true;
        
        const otp = await mail.getOTP(180);
        if (otp) {
            otpCell.innerHTML = `
                <span class="copy-otp" onclick="copyToClipboard('${otp}')">${otp}</span>
                <span style="color:green">‚úÖ</span>
            `;
            statusCell.innerHTML = 'üü¢ Th√†nh c√¥ng';
        } else {
            otpCell.innerHTML = '<span style="color:red">‚ùå Kh√¥ng t√¨m th·∫•y</span>';
            statusCell.innerHTML = 'üî¥ Kh√¥ng c√≥ OTP';
        }
    } catch (e) {
        otpCell.innerHTML = `<span style="color:red">‚õî L·ªói: ${e.message}</span>`;
        statusCell.innerHTML = 'üî¥ L·ªói h·ªá th·ªëng';
    } finally {
        button.disabled = false;
    }
}

// S·ª≠a h√†m copyToClipboard
function copyToClipboard(text) {
    const toast = document.getElementById('toast');
    navigator.clipboard.writeText(text).then(() => {
        toast.textContent = `üìã ƒê√£ copy: ${text}`;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    });
}

// X√≥a b·∫£ng
function clearTable() {
    document.getElementById('tableBody').innerHTML = '';
    document.getElementById('accountInput').value = '';
}

// Th√™m h√†m t·∫°o t√†i kho·∫£n ng·∫´u nhi√™n
async function createRandomAccount() {
    const domainInput = document.getElementById('domainInput').value.trim();
    if (domainInput) {
        if (!/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(domainInput)) {
            showToast('Domain kh√¥ng h·ª£p l·ªá!', 'error');
            return;
        }
    }

    const mail = new MailTM();
    const account = await mail.createAccount();
    
    if(account.error) {
        showToast(`L·ªói t·∫°o t√†i kho·∫£n: ${account.error}`, 'error');
        return;
    }
    
    // Th√™m v√†o textarea v√† import
    const textarea = document.getElementById('accountInput');
    textarea.value += `${account.email}|${account.password}\n`;
    importAccounts();
    showToast('ƒê√£ t·∫°o t√†i kho·∫£n m·ªõi!', 'success');
}

// S·ª≠a h√†m showToast ƒë·ªÉ h·ªó tr·ª£ nhi·ªÅu lo·∫°i th√¥ng b√°o
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = ''; // Reset class
    toast.classList.add(type, 'show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

</script>
</body>
</html>